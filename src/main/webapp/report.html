<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML xmlns:Tree xmlns:Grid xmlns:XForm>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>WMSX--业务报表</title>

<link href="framework/css/css.css" rel="stylesheet" type="text/css"></link>
<link href="framework/menu/menu.css" rel="stylesheet" type="text/css"></link>
<link href="framework/balloon/balloon.css" rel="stylesheet" type="text/css"></link>
<link href="framework/toolbar/toolbar.css" rel="stylesheet" type="text/css"></link>
<link href="framework/workspace/workspace.css" rel="stylesheet" type="text/css"></link>
<link href="framework/tree/tree.css" rel="stylesheet" type="text/css"></link>
<link href="framework/grid/grid.css" rel="stylesheet" type="text/css"></link>
<link href="framework/xform/xform.css" rel="stylesheet" type="text/css"></link>

<script language="javascript" src="framework/core.js"></script>
<script language="javascript" src="framework/ajax.js"></script>
<script language="javascript" src="framework/framework.js"></script>
<script language="javascript" src="framework/menu/menu.js"></script>
<script language="javascript" src="framework/balloon/balloon.js"></script>
<script language="javascript" src="framework/toolbar/toolbar.js"></script>
<script language="javascript" src="framework/workspace/workspace.js"></script>
<script language="javascript" src="framework/tree/tree.js"></script>
<script language="javascript" src="framework/grid/grid.js"></script>
<script language="javascript" src="framework/xform/xform.js"></script>

<SCRIPT type="text/javascript">
<!--
 
/* 框架包相对路径 */
URL_CORE = "framework/"; 
    
    /*
     *	后台响应数据节点名称
     */
    XML_SOURCE_TREE = "SourceTree";
    XML_REPORT_DATA = "ReportData";
    XML_SOURCE_INFO = "SourceInfo";
 
    /*
     *	XMLHTTP请求地址汇总
     */
	URL_SOURCE_TREE    = "report/list";
    URL_REPORT_DATA    = "report/";
    URL_SOURCE_INFO	   = "report/detail";
	URL_SAVE_SOURCE    = "report";
    URL_DELETE_SOURCE  = "report/";
    URL_DISABLE_SOURCE = "report/disable/";
    URL_SORT_SOURCE    = "report/sort/";
    URL_COPY_SOURCE    = "report/copy/";
    URL_MOVE_SOURCE_TO = "report/move/";

	if(IS_TEST || true) {
		URL_SOURCE_TREE    = "data/report_init.xml?";
		URL_REPORT_DATA    = "data/reportData2.xml?";
		URL_SOURCE_INFO    = "data/report1.xml?";
		URL_SAVE_SOURCE    = "data/_success.xml?";
		URL_DELETE_SOURCE  = "data/_success.xml?";
		URL_DISABLE_SOURCE = "data/_success.xml?";
		URL_SORT_SOURCE    = "data/_success.xml?";
		URL_COPY_SOURCE    = "data/_success.xml?";
		URL_MOVE_SOURCE_TO = "data/_success.xml?";
	}
	
    /* 页面初始化 */
    function init() {
		initPaletteResize();
		initListContainerResize();

		initNaviBar("wmsx.1", " ");
		initMenus();
		initBlocks();
		initEvents();
		initFocus();

		loadInitData();
    }
	    
	function initBlocks() {
        var paletteObj = $("palette");
        Blocks.create(paletteObj);

        var treeContainerObj = $("treeContainer");
        Blocks.create(treeContainerObj,treeContainerObj.parentNode);  
    }
	
	function initFocus() {
        Focus.register($("treeTitle").firstChild);
        Focus.register($("gridTitle"));
    }

    function initEvents() {
        Event.attachEvent($("treeBtRefresh"), "click", onClickTreeBtRefresh);
        Event.attachEvent($("treeTitle"), "click", onClickTreeTitle);
        Event.attachEvent($("gridTitle"), "click", onClickGridTitle);
    }
 
    /* 菜单初始化 */
    function initMenus() {
		/* 树菜单初始化  */
		var item1 = {
			label:"报表查询",
			callback:searchReport,
			icon:"framework/images/search.gif",
			visible:function() {return isReport();}
		}
		var item2 = {
			label:"修改",
			callback:modifyReport,
			icon:"framework/images/icon_edit.gif",
			visible:function() {return !isTreeRoot()}
		}
		var item3 = {
			label:"新增报表",
			callback:addReport,
			icon:"framework/images/new_article.gif",
			visible:function() {return isReportGroup() || isTreeRoot();}
		}
		var item4 = {
			label:"新增分组",
			callback:addReport,
			icon:"framework/images/new_folder.gif",
			visible:function() {return isReportGroup() || isTreeRoot();}
		}
		var item5 = {
			label:"删除",
			callback:deleteReport,
			icon:"framework/images/icon_del.gif",
			visible:function() {return !isTreeRoot();}
		}
		var item6 = {
			label:"复制到",
			callback:deleteReport,
			icon:"framework/images/icon_copy.gif",
			visible:function() {return isReport();}
		}
		var item7 = {
			label:"移动到",
			callback:deleteReport,
			icon:"framework/images/icon_move.gif",
			visible:function() {return isReport();}
		}
		var item8 = {
			label:"停用",
			callback:disableReport,
			icon:"framework/images/stop.gif",
			visible:function() {return !isTreeRoot() && !isTreeNodeDisabled();}
		}
		var item9 = {
			label:"启用",
			callback:enableReport,
			icon:"framework/images/start.gif",
			visible:function() {return !isTreeRoot() && isTreeNodeDisabled();}
		}

		var treeObj = $("tree");

		var menu = new Menu();
		menu.addItem(item1);
		menu.addItem(item2);
		menu.addItem(item3);
		menu.addItem(item4);
		menu.addItem(item5);
		menu.addSeparator();
		menu.addItem(item6);
		menu.addItem(item7);
		menu.addItem(item8);
		menu.addItem(item9);
		
		treeObj.contextmenu = menu;
    }
	
	function getTreeId() {
        var treeNode = $T("tree").getActiveTreeNode();
        return treeNode.getId();
    }

	function getTreeNodeType() {
        return getTreeAttribute("type");
    }
	
	function isReportGroup() {
		var treeNode = $T("tree").getActiveTreeNode(); 
		return "0" == getTreeNodeType();
	}
	
	function isReport() {
		return !isTreeRoot() && !isReportGroup();
	}

	function loadInitData() {
        var onresult = function() {
            var tree = $T("tree", this.getNodeValue(XML_SOURCE_TREE));

			var treeElement = $("tree");
            treeElement.onTreeNodeActived = function(eventObj) {
                Focus.focus($("treeTitle").firstChild.id);
            }
            treeElement.onTreeNodeDoubleClick = function(eventObj) {
               if( isReport() ) {
					searchReport();
				}
            }
            treeElement.onTreeNodeRightClick = function(eventObj) {
				if($("tree").contextmenu) {
					$("tree").contextmenu.show(eventObj.clientX, eventObj.clientY);                
				}
            }
        }

        Ajax({url : URL_SOURCE_TREE, method : "GET", onresult : onresult});
    }
	
	function addReport() {
	}
	
	function modifyReport() {
	}
	
	function deleteReport() {
	}
	
	function disableReport() {
	}

	function enableReport() {

	}

	function enableOrDisable(status) {
        var tree = $T("tree");
        var treeNode = tree.getActiveTreeNode();
		Ajax({
			url : URL_PARAM_DISABLE + treeNode.getId() + "/" + status,
			onsuccess : function() { 
				var xmlNode = new XmlNode(treeNode.node);
				refreshTreeNodeStates(xmlNode, status);

				loadToolBar(); // 刷新工具条
			}
		});
    }

	function sort(eventObj) {
		var movedTreeNode = eventObj.movedTreeNode;
        var toTreeNode = eventObj.toTreeNode;
        var moveState  = eventObj.moveState; // -1: 目标上方, 1: 目标下方

		Ajax({
			url : URL_SORT_SOURCE + movedTreeNode.getId() + "/" + toTreeNode.getId() + "/" + moveState,
			onsuccess : function() { 
				 $T("tree").moveTreeNode(movedTreeNode, toTreeNode, moveState);
			}
		});
	}

	function copyReportTo() {
		var treeNode = $T("tree").getActiveTreeNode();
		var id = treeNode.getId();
		var name = treeNode.getName();
		var parentID = treeNode.getParent().getId();

		var params = { id:id, parentID:parentID };
		var targetParent = window.showModalDialog("paramtree.htm", {params:params, title:"将【\"" + name + "\"】复制到"}, "dialogWidth:300px;dialogHeight:400px;");
		
		if( targetParent ) {
			var targetParentId = targetParent.id;
			Ajax({
				url : URL_COPY_PARAM + id + "/" + targetParentId,
				onresult : function() { 
					var newNode = this.getNodeValue(XML_MAIN_TREE).selectSingleNode("treeNode");
					appendTreeNode(targetParentId, newNode);
				}
			});
		}
	}
	
	function moveReport() {
		var tree = $T("tree");
        var treeNode = tree.getActiveTreeNode();
		var id = treeNode.getId();
		var name = treeNode.getName();
		var parentID = treeNode.getParent().getId();

		var params = { id:id, parentID:parentID };
		var targetParent = window.showModalDialog("paramtree.htm", {params:params, title:"将\"" + name + "\"移动到"},"dialogWidth:300px;dialogHeight:400px;");
	   
		if(targetParent) {
			var targetParentId = targetParent.id;
			Ajax({
				url : URL_MOVE_PARAM_TO + id + "/" + targetParentId,
				onsuccess : function() { 
					// 移动树节点
					var parentNode = tree.getTreeNodeById(targetParentId);
					parentNode.node.appendChild(treeNode.node);

					var xmlNode = new XmlNode(treeNode.node);
					refreshTreeNodeStates(xmlNode, parentNode.getAttribute("disabled"));
					clearOperation(xmlNode);

					tree.reload();
				}
			});
		}
	}
		
	
    function searchReport() {
        var treeNode = $T("tree").getActiveTreeNode();
		var treeID = treeNode.getId();
		var treeName = treeNode.getName();
		
		var p = new HttpRequestParams();
		
		var condition = window.showModalDialog("searchlog.htm", {applicationId:treeID, title:"搜索\"" + treeName + "\"下的日志"}, "dialogWidth:250px;dialogHeight:250px;");
		if( condition ) { 
			Cache.Variables.add("condition", condition);
			
			
			var xmlReader = new XmlReader(condition.dataXml);
			var dataNode  = new XmlNode(xmlReader.documentElement);
			p.setXFormContent(dataNode, condition.prefix);
			
		} 
		
		loadGridData(p, treeID, "1"); 
    }
	
    function loadGridData(p, treeID, page) {
		p.url = URL_REPORT_DATA + page || "1";
		var request = new HttpRequest(p);
		request.onresult = function() {
			$G("grid", this.getNodeValue(XML_REPORT_DATA)); 

			var pageListNode = this.getNodeValue(XML_PAGE_INFO);			
			initGridToolBar($("gridToolBar"), pageListNode, function(page) {
				request.params.url = URL_REPORT_DATA + page;
				request.onresult = function() {
					$G("grid", this.getNodeValue(XML_REPORT_DATA)); 
				}				
				request.send();
			} );
			
			var gridElement = $("grid"); 
			gridElement.onDblClickRow = function(eventObj) {
				showLogInfo();
			}
			gridElement.onRightClickRow = function() {
				$("grid").contextmenu.show(event.clientX, event.clientY);
			}   
			gridElement.onScrollToBottom = function () {			
				var currentPage = request.getParamValue("page");
				var nextPage = parseInt(currentPage) + 1; 
				request.params.url = URL_REPORT_DATA + nextPage;
				request.onresult = function() {
					$G("grid").load(this.getNodeValue(XML_REPORT_DATA), true);
				}				
				request.send();
			}
		}
		request.send();
    } 
 
	
	
    window.onload = init;

    window.attachEvent("onunload", function() {
        if(10000 < window.screenTop || 10000 < window.screenLeft) {
            logout(); // 关闭页面自动注销
        }
	});

//-->
</SCRIPT>

</head>

<body>

<table class="panel" cellpadding="0" cellspacing="0">
  <tr class="header"> 
	<td class="left"></td>
	<td class="center"></td>
	<td class="right"></td>
  </tr>
  <tr class="body"> 
	<td class="left"></td>
	<td class="center">
	  <!-- 版面内容-->
	  <table class="full"  border="0" cellpadding="0" cellspacing="0">
		<tr> 
		  <td height="20"> <!-- 主菜单 -->
			  <div id="navibar"><div class="loading"></div></div>
			</td>			
		</tr>
		<tr> 
		  <td class="separator"></td>
		</tr>

		<tr> <td><table  class="full" cellpadding="0" cellspacing="0"><tr>
			<td id="palette">
			  <!-- 左栏 -->
			  <table class=" border full">
				<tr id="treeTitle" class="bar"> 
				  <td class="opened">
					<span class="icon"></span>资源<span class="button refresh" id="treeBtRefresh" title="刷新"></span></span>
				  </td>
				</tr>
				<tr>
				  <td id="treeContainer">
					<Tree:Box id="tree" treeType="menu" baseurl="framework/tree/"><div class="loading"></div></Tree:Box>
				  </td>
				</tr>
			  </table>                        
			</td>
			<td id="listContainer" class="gridContainer">
				<table class="full border" cellpadding="0" cellspacing="0">
				  <tr>
					<td id="gridTitle">
					  <span class="icon"></span>报表查询结果<span class="buttonBox" id="gridToolBar"></span>
					</td>
				  </tr>
				  <tr>
					<td>
					   <Grid:Box id="grid" baseurl="framework/grid/"></Grid:Box>
					</td>
				  </tr>
				</table>
			</td>
		  </tr></table></td></tr>
	  </table>            
	</td>
	<td class="right"></td>
  </tr>
  <tr class="footer"> 
	<td class="left"></td>
	<td class="center"></td>
	<td class="right"></td>
  </tr>
</table>

<div style="display:none">
	<XForm:Box id="reportForm" baseurl="framework/xform/"><div class="loading"></div></XForm:Box>
</div>

<div style="display:none">
	<XForm:Box id="searchForm" baseurl="framework/xform/"><div class="loading"></div></XForm:Box>
</div>

</body>
</html>
