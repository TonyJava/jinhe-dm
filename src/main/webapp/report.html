<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML xmlns:Tree xmlns:Grid xmlns:XForm>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>WMSX--业务报表</title>

<link href="framework/css/css.css" rel="stylesheet" type="text/css"></link>
<link href="framework/menu/menu.css" rel="stylesheet" type="text/css"></link>
<link href="framework/balloon/balloon.css" rel="stylesheet" type="text/css"></link>
<link href="framework/toolbar/toolbar.css" rel="stylesheet" type="text/css"></link>
<link href="framework/workspace/workspace.css" rel="stylesheet" type="text/css"></link>
<link href="framework/tree/tree.css" rel="stylesheet" type="text/css"></link>
<link href="framework/grid/grid.css" rel="stylesheet" type="text/css"></link>
<link href="framework/xform/xform.css" rel="stylesheet" type="text/css"></link>

<script language="javascript" src="framework/core.js"></script>
<script language="javascript" src="framework/ajax.js"></script>
<script language="javascript" src="framework/framework.js"></script>
<script language="javascript" src="framework/menu/menu.js"></script>
<script language="javascript" src="framework/balloon/balloon.js"></script>
<script language="javascript" src="framework/toolbar/toolbar.js"></script>
<script language="javascript" src="framework/workspace/workspace.js"></script>
<script language="javascript" src="framework/tree/tree.js"></script>
<script language="javascript" src="framework/grid/grid.js"></script>
<script language="javascript" src="framework/xform/xform.js"></script>

<SCRIPT type="text/javascript">
<!--
 
    /*
     *	后台响应数据节点名称
     */
    XML_SOURCE_TREE = "SourceTree";
    XML_REPORT_DATA = "ReportData";
    XML_SOURCE_INFO = "SourceInfo";
 
    /*
     *	XMLHTTP请求地址汇总
     */
	URL_SOURCE_TREE    = "rp/all";
	URL_GROUPS_TREE    = "rp/groups";
    URL_REPORT_DATA    = "rp/";
    URL_SOURCE_DETAIL  = "rp/detail";
	URL_SAVE_SOURCE    = "rp";
    URL_DELETE_SOURCE  = "rp/";
    URL_DISABLE_SOURCE = "rp/disable/";
    URL_SORT_SOURCE    = "rp/sort/";
    URL_COPY_SOURCE    = "rp/copy/";
    URL_MOVE_SOURCE    = "rp/move/";

	if(IS_TEST) {
		URL_SOURCE_TREE    = "data/report_init.xml?";
		URL_GROUPS_TREE    = "data/report_init.xml?";
		URL_REPORT_DATA    = "data/reportData2.xml?";
		URL_SOURCE_DETAIL  = "data/report1.xml?";
		URL_SAVE_SOURCE    = "data/_success.xml?";
		URL_DELETE_SOURCE  = "data/_success.xml?";
		URL_DISABLE_SOURCE = "data/_success.xml?";
		URL_SORT_SOURCE    = "data/_success.xml?";
		URL_COPY_SOURCE    = "data/_success.xml?";
		URL_MOVE_SOURCE    = "data/_success.xml?";
	}
	
    /* 页面初始化 */
    function init() {
		initPaletteResize();
		initListContainerResize();

		initNaviBar("wmsx.1", " ");
		initMenus();
		initBlocks();
		initEvents();
		initFocus();

		loadInitData();
    }
	    
	function initBlocks() {
        var paletteObj = $("palette");
        Blocks.create(paletteObj);

        var treeContainerObj = $("treeContainer");
        Blocks.create(treeContainerObj,treeContainerObj.parentNode);  
    }
	
	function initFocus() {
        Focus.register($("treeTitle").firstChild);
        Focus.register($("gridTitle"));
    }

    function initEvents() {
        Event.attachEvent($("treeBtRefresh"), "click", onClickTreeBtRefresh);
        Event.attachEvent($("treeTitle"), "click", onClickTreeTitle);
        Event.attachEvent($("gridTitle"), "click", onClickGridTitle);
    }
 
    /* 菜单初始化 */
    function initMenus() {
		/* 树菜单初始化  */
		var item1 = {
			label:"报表查询",
			callback:searchReport,
			icon:"framework/images/search.gif",
			visible:function() {return isReport();}
		}
		var item10 = {
			label:"查看",
			callback: function() {
                loadReportDetail(false, true);
            },
			icon:"framework/images/view.gif",
			visible:function() {return !isTreeRoot()}
		}
		var item2 = {
			label:"修改",
			callback: function() {
                loadReportDetail(false, false);
            },
			icon:"framework/images/icon_edit.gif",
			visible:function() {return !isTreeRoot()}
		}
		var item3 = {
			label:"新增报表",
			callback: function() {
                loadReportDetail(true, false, "1");
            },
			icon:"framework/images/new_article.gif",
			visible:function() {return isReportGroup() || isTreeRoot();}
		}
		var item4 = {
			label:"新增分组",
			callback: function() {
                loadReportDetail(true, false, "0");
            },
			icon:"framework/images/new_folder.gif",
			visible:function() {return isReportGroup() || isTreeRoot();}
		}
		var item5 = {
			label:"删除",
			callback:deleteReport,
			icon:"framework/images/icon_del.gif",
			visible:function() {return !isTreeRoot();}
		}
		var item6 = {
			label:"复制到",
			callback:copyReportTo,
			icon:"framework/images/icon_copy.gif",
			visible:function() {return isReport();}
		}
		var item7 = {
			label:"移动到",
			callback:deleteReport,
			icon:"framework/images/icon_move.gif",
			visible:function() {return isReport();}
		}
		var item8 = {
			label:"停用",
			callback:disableReport,
			icon:"framework/images/stop.gif",
			visible:function() {return !isTreeRoot() && !isTreeNodeDisabled();}
		}
		var item9 = {
			label:"启用",
			callback:enableReport,
			icon:"framework/images/start.gif",
			visible:function() {return !isTreeRoot() && isTreeNodeDisabled();}
		}

		var treeObj = $("tree");

		var menu = new Menu();
		menu.addItem(item1);
		menu.addSeparator();
		menu.addItem(item10);
		menu.addItem(item2);
		menu.addItem(item3);
		menu.addItem(item4);
		menu.addItem(item5);
		menu.addSeparator();
		menu.addItem(item6);
		menu.addItem(item7);
		menu.addItem(item8);
		menu.addItem(item9);
		
		treeObj.contextmenu = menu;
    }
	
	function getTreeId() {
        var treeNode = $T("tree").getActiveTreeNode();
        return treeNode.getId();
    }

	function getTreeNodeType() {
        return getTreeAttribute("type");
    }
	
	function isReportGroup() {
		var treeNode = $T("tree").getActiveTreeNode(); 
		return "0" == getTreeNodeType();
	}
	
	function isReport() {
		return !isTreeRoot() && !isReportGroup();
	}

	function loadInitData() {
        var onresult = function() {
            var tree = $T("tree", this.getNodeValue(XML_SOURCE_TREE));

			var treeElement = $("tree");
            treeElement.onTreeNodeActived = function(eventObj) {
                Focus.focus($("treeTitle").firstChild.id);
            }
            treeElement.onTreeNodeDoubleClick = function(eventObj) {
               if( isReport() ) {
					searchReport();
				}
				if( isReportGroup() ) {
					loadReportDetail(false, false);
				}
            }
            treeElement.onTreeNodeRightClick = function(eventObj) {
				if($("tree").contextmenu) {
					$("tree").contextmenu.show(eventObj.clientX, eventObj.clientY);                
				}
            }
			treeElement.onTreeNodeMoved = function(eventObj) {
				sort(eventObj);
			}
        }

        Ajax({url : URL_SOURCE_TREE, onresult : onresult});
    }
	
	function showFloatingDiv(div) {
		div.style.display = "block";
		div.style.width  = "80%";    
		div.style.height = "80%";    
		div.style.position = "absolute";    
		div.style.left = "200px";   
		div.style.top  = "70px"; 		
		div.style.zIndex = "10000"; 
		div.style.background = "#BEC6EE";   
		Element.setOpacity(div, 80);
	}
	
	function loadReportDetail(isCreate, readonly, type) { 
		var treeNode = $T("tree").getActiveTreeNode();
		var treeID = treeNode.getId();
		type = type || treeNode.getAttribute("type") ;
		
		showFloatingDiv($("reportFormDiv"));
		
		var params = {};
		if( isCreate ) {
		    params["parentId"] = treeID; // 新增
			readonly = false;
		} else {
			params["reportId"] = treeID; // 修改					
		}

		Ajax({
			url : URL_SOURCE_DETAIL + "/" + type,
			contents : params,
			onresult : function() { 
				var sourceInfoNode = this.getNodeValue(XML_SOURCE_INFO);
				Cache.XmlDatas.add(treeID, sourceInfoNode);
				
				$("reportForm").editable = readonly ? "false" : "true";
				var xform = $X("reportForm", sourceInfoNode);

				attachReminder(treeID, xform); // 离开提醒
			
				// 设置保存/关闭按钮操作
				$("closeReportForm").onclick = function() {
					$("reportFormDiv").style.display = "none";
				}
				$("sourceSave").onclick = function() {
					saveReport(treeID);
				}
			},
			onexception : function() { 
				$("reportFormDiv").style.display = "none";
			}
		});
	}
	
	function saveReport(treeID) {
        var xform = $X("reportForm");	
        if( !xform.checkForm() ) return;

        var p = new HttpRequestParams();
        p.url = URL_SAVE_SOURCE;

        //是否提交
        var flag = false;
        
		//参数基本信息
		var sourceInfoNode = Cache.XmlDatas.get(treeID);
		if( sourceInfoNode ) {
			var paramInfoDataNode = sourceInfoNode.selectSingleNode(".//data");
			if( paramInfoDataNode ) {
				flag = true;
				p.setXFormContent(paramInfoDataNode);
			}
		}

        if( flag ) {
            var request = new HttpRequest(p);
           
            syncButton([$("sourceSave")], request); // 同步按钮状态
			detachReminder(treeID); // 解除提醒

            request.onresult = function() { // 新增结果返回              
				var treeNode = this.getNodeValue(XML_SOURCE_TREE).selectSingleNode("treeNode");
				appendTreeNode(treeID, treeNode); // treeID即为父节点

				$("reportFormDiv").style.display = "none";
            }

            request.onsuccess = function() { // 更新
				var name = xform.getData("name");
				if( isNullOrEmpty(name) ) {
					modifyTreeNode(treeID, "name", name, true);
				}
				
				$("reportFormDiv").style.display = "none";
            }
            request.send();
        }
    }
	
	function deleteReport() {
		if( !confirm("您确定要删除吗？") )  return;
        
        var tree = $T("tree");
        var treeNode = tree.getActiveTreeNode();
		Ajax({
			url : URL_SOURCE_DELETE + treeNode.getId(),
			method : "DELETE",
			onsuccess : function() { 
				var parentNode = treeNode.getParent();
				if( parentNode ) {
					tree.setActiveTreeNode(parentNode.getId());
				}
				tree.removeTreeNode(treeNode);
			}
		});	
	}
	
	function disableReport() {
		disable(1);
	}

	function enableReport() {
		disable(0);
	}

	function disable(status) {
        var tree = $T("tree");
        var treeNode = tree.getActiveTreeNode();
		Ajax({
			url : URL_DISABLE_SOURCE + treeNode.getId() + "/" + status,
			onsuccess : function() { 
				var xmlNode = new XmlNode(treeNode.node);
				refreshTreeNodeStates(xmlNode, status);
			}
		});
    }
	
	/*
     *	刷新级联树节点停用启用状态
     *	参数：	XmlNode:curNode         XmlNode实例
                string:state            停/启用状态
     */
    function refreshTreeNodeStates(curNode, state) {
        refreshTreeNodeState(curNode, state);

        if("0" == state) { // 启用，上溯
            while( curNode && "_rootId" != curNode.getAttribute("id") ) {
                refreshTreeNodeState(curNode, state);
                curNode = curNode.getParent();
            }        
        }
		else if("1" == state) { // 停用，下溯
            var childNodes = curNode.selectNodes(".//treeNode");
            for(var i=0; i < childNodes.length; i++) {                
                refreshTreeNodeState(childNodes[i], state);
            }
        }

        $T("tree").reload(); 
    }
	
	function refreshTreeNodeState(treeNode, state) {
        state = state || treeNode.getAttribute("disabled");
        var type = treeNode.getAttribute("type");
        switch(type) {
            case "0":
                var img = "framework/images/folder";
                break;
            case "1":
                var img = "framework/images/article";
                break;
        }
        treeNode.setAttribute("disabled", state);
        treeNode.setAttribute("icon", img + (state == "1" ? "_2" : "") + ".gif");       
    }

	function sort(eventObj) {
		var movedNode  = eventObj.movedTreeNode;
        var targetNode = eventObj.toTreeNode;
        var direction  = eventObj.moveState; // -1: 往上, 1: 往下

		Ajax({
			url : URL_SORT_SOURCE + movedNode.getId() + "/" + targetNode.getId() + "/" + direction,
			onsuccess : function() { 
				 $T("tree").moveTreeNode(movedNode, targetNode, direction);
			}
		});
	}

	function copyReportTo() {
		var treeNode = $T("tree").getActiveTreeNode();
		var id = treeNode.getId();
		var name = treeNode.getName();
		var parentID = treeNode.getParent().getId();

		var params = { id:id, parentID:parentID };
		var targetParent = window.showModalDialog("paramtree.htm", {params:params, title:"将【\"" + name + "\"】复制到"}, "dialogWidth:300px;dialogHeight:400px;");
		
		if( targetParent ) {
			var targetParentId = targetParent.id;
			Ajax({
				url : URL_COPY_SOURCE + id + "/" + targetParentId,
				onresult : function() { 
					var newNode = this.getNodeValue(XML_SOURCE_TREE).selectSingleNode("treeNode");
					appendTreeNode(targetParentId, newNode);
				}
			});
		}
	}
	
	function moveReport() {
		var tree = $T("tree");
        var treeNode = tree.getActiveTreeNode();
		var id = treeNode.getId();
		var name = treeNode.getName();
		var parentID = treeNode.getParent().getId();

		var params = { id:id, parentID:parentID };
		var targetParent = window.showModalDialog("paramtree.htm", {params:params, title:"将\"" + name + "\"移动到"},"dialogWidth:300px;dialogHeight:400px;");
	   
		if(targetParent) {
			var targetParentId = targetParent.id;
			Ajax({
				url : URL_MOVE_SOURCE + id + "/" + targetParentId,
				onsuccess : function() { 
					// 移动树节点
					var parentNode = tree.getTreeNodeById(targetParentId);
					parentNode.node.appendChild(treeNode.node);

					var xmlNode = new XmlNode(treeNode.node);
					refreshTreeNodeStates(xmlNode, parentNode.getAttribute("disabled"));
					clearOperation(xmlNode);

					tree.reload();
				}
			});
		}
	}
		
	
    function searchReport() {
        var treeNode = $T("tree").getActiveTreeNode();
		var treeID = treeNode.getId();
		var treeName = treeNode.getName();
		
		var p = new HttpRequestParams();
		
		var condition = window.showModalDialog("searchlog.htm", {applicationId:treeID, title:"搜索\"" + treeName + "\"下的日志"}, "dialogWidth:250px;dialogHeight:250px;");
		if( condition ) { 
			Cache.Variables.add("condition", condition);
			
			
			var xmlReader = new XmlReader(condition.dataXml);
			var dataNode  = new XmlNode(xmlReader.documentElement);
			p.setXFormContent(dataNode, condition.prefix);
			
		} 
		
		loadGridData(p, treeID, "1"); 
    }
	
    function loadGridData(p, treeID, page) {
		p.url = URL_REPORT_DATA + page || "1";
		var request = new HttpRequest(p);
		request.onresult = function() {
			$G("grid", this.getNodeValue(XML_REPORT_DATA)); 

			var pageListNode = this.getNodeValue(XML_PAGE_INFO);			
			initGridToolBar($("gridToolBar"), pageListNode, function(page) {
				request.params.url = URL_REPORT_DATA + page;
				request.onresult = function() {
					$G("grid", this.getNodeValue(XML_REPORT_DATA)); 
				}				
				request.send();
			} );
			
			var gridElement = $("grid"); 
			gridElement.onDblClickRow = function(eventObj) {
				showLogInfo();
			}
			gridElement.onRightClickRow = function() {
				$("grid").contextmenu.show(event.clientX, event.clientY);
			}   
			gridElement.onScrollToBottom = function () {			
				var currentPage = request.getParamValue("page");
				var nextPage = parseInt(currentPage) + 1; 
				request.params.url = URL_REPORT_DATA + nextPage;
				request.onresult = function() {
					$G("grid").load(this.getNodeValue(XML_REPORT_DATA), true);
				}				
				request.send();
			}
		}
		request.send();
    } 
 
 	function loadGroupsTree(operatedNodeID) {		
		Ajax({
			url : URL_GROUPS_TREE,
			onresult : function() { 
				var tree = $T("groupTree", this.getNodeValue(XML_SOURCE_TREE));		
				$("groupTree").onTreeNodeDoubleClick = function(eventObj) {
					getTargetParent();
				}
			}
		});
	}
	
	function getTargetParent() {
		var treeNode = $T("groupTree").getActiveTreeNode();
		if( treeNode ) {
			return treeNode.getId();
		}
	}
	
	
    window.onload = init;

    window.attachEvent("onunload", function() {
        if(10000 < window.screenTop || 10000 < window.screenLeft) {
            logout(); // 关闭页面自动注销
        }
	});

//-->
</SCRIPT>

</head>

<body>

<table class="panel" cellpadding="0" cellspacing="0">
  <tr class="header"> 
	<td class="left"></td>
	<td class="center"></td>
	<td class="right"></td>
  </tr>
  <tr class="body"> 
	<td class="left"></td>
	<td class="center">
	  <!-- 版面内容-->
	  <table class="full"  border="0" cellpadding="0" cellspacing="0">
		<tr> 
		  <td height="20"> <!-- 主菜单 -->
			  <div id="navibar"><div class="loading"></div></div>
			</td>			
		</tr>
		<tr> 
		  <td class="separator"></td>
		</tr>

		<tr> <td><table  class="full" cellpadding="0" cellspacing="0"><tr>
			<td id="palette">
			  <!-- 左栏 -->
			  <table class=" border full">
				<tr id="treeTitle" class="bar"> 
				  <td class="opened">
					<span class="icon"></span>资源<span class="button refresh" id="treeBtRefresh" title="刷新"></span></span>
				  </td>
				</tr>
				<tr>
				  <td id="treeContainer">
					<Tree:Box id="tree" treeType="menu" baseurl="framework/tree/" canMoveNode="true"><div class="loading"></div></Tree:Box>
				  </td>
				</tr>
			  </table>                        
			</td>
			<td id="listContainer" class="gridContainer">
				<table class="full border" cellpadding="0" cellspacing="0">
				  <tr>
					<td id="gridTitle">
					  <span class="icon"></span>报表查询结果<span class="buttonBox" id="gridToolBar"></span>
					</td>
				  </tr>
				  <tr>
					<td>
					   <Grid:Box id="grid" baseurl="framework/grid/"></Grid:Box>
					</td>
				  </tr>
				</table>
			</td>
		  </tr></table></td></tr>
	  </table>            
	</td>
	<td class="right"></td>
  </tr>
  <tr class="footer"> 
	<td class="left"></td>
	<td class="center"></td>
	<td class="right"></td>
  </tr>
</table>

<div id="reportFormDiv" style="display:none">
	<XForm:Box id="reportForm" baseurl="framework/xform/"><div class="loading"></div></XForm:Box>
	<input type="button" class="btStrong" value="保存" id="sourceSave"/>
	<input type="button" class="btStrong" value="关闭" id="closeReportForm"/>
</div>

<div id="searchFormDiv" style="display:none">
	<XForm:Box id="searchForm" baseurl="framework/xform/"><div class="loading"></div></XForm:Box>
</div>

<div id="groupTreeDiv" style="display:none">
	<Tree:Box id="groupTree" treeType="menu" baseurl="../../tree/"><div class="loading"></div></Tree:Box>
	<input type="button" value="确定" class="btStrong" onclick="getTargetParent()"/>
    <input type="button" value="关闭" class="btWeak" onclick="$('groupTreeDiv').style.display = 'none'"/> 
</div>

</body>
</html>
