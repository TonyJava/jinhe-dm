<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>305</title>

    <script type="text/javascript" src="../../framework/core.js"></script>
    <script type="text/javascript" src="../../framework/ajax.js"></script> 
    <script type="text/javascript" src="../js/jquery-1.10.1.min.js"></script>
    <script type="text/javascript" src="../js/highcharts.js"></script>
    <script src="../js/exporting.js"></script>

    <script type="text/javascript">
    var inMonth;
    var searchType;
    var whichPro;

    Array.prototype.contains = function(obj) {  
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }  


    var serviceUrl = "../../display/json/305";
    
    function query() {

        var inDate = $$("inDate").value;      
        var mst = new Date($$("inDate").value);    
        inMonth = mst.getMonth()+1;
        var selectType = $$("selectType").value;
        whichPro = $$("whichPro").value;

        switch(selectType)
        {
        case '4':
          searchType = '总货量'
          break;
        case '3':
          searchType = '单价'
          break;
        case '2':
          searchType = '总成本'
          break;
        default:
          searchType = '总收入'
        };     

        Ajax({
            url : serviceUrl,
            method : "POST",
            params : {"param1": inMonth,"param2": whichPro,"param3": searchType},
            type : "json",
            waiting : true,
            ondata : function() {
                var data = eval(this.getResponseText());
                show(data);
            }
        });   
    }

    function show(originData) {
        var FactFee = [];
        var BudgetFee = [];
        var label = [];
        var scaledata = 0;
        var blankspace = 0;
        var biggerdata=0;
        var maxdata = 0;


        for(var i = 0; i < originData.length; i++) {
            var budgetFee = originData[i]["budgetFee"];
            var factFee = originData[i]["factFee"];
            var details   = originData[i]["detail6"];
            biggerdata = Math.max(budgetFee,factFee);
            if (maxdata < biggerdata) {
                maxdata = biggerdata;
            };
            
            FactFee[i] = factFee;
            BudgetFee[i] =  - budgetFee;
            label[i] = details;
        };

        if (maxdata<10) {
            scaledata=Math.ceil(maxdata);
        };

        if (maxdata<100 && maxdata>=10) {
            scaledata=Math.ceil(maxdata/10) * 10;
        };

        if (maxdata<1000 && maxdata>=100) {
            scaledata=Math.ceil(maxdata/100) * 100;
        };

        if (maxdata<10000 && maxdata>=1000) {
            scaledata=Math.ceil(maxdata/1000) * 1000;
        };

        if (maxdata<100000 && maxdata>=10000) {
            scaledata=Math.ceil(maxdata/10000) * 10000;
        };

        if (maxdata<1000000 && maxdata>=100000) {
            scaledata=Math.ceil(maxdata/100000) * 100000;
        };

        if (maxdata<10000000 && maxdata>=1000000) {
            scaledata=Math.ceil(maxdata/1000000) * 1000000;
        };

        if (maxdata<100000000 && maxdata>=10000000) {
            scaledata=Math.ceil(maxdata/10000000) * 10000000;
        };
        
           
        $(function () {
            var chart,
                categories = label;
            $(document).ready(function() {
                $('#container').highcharts({
                    chart: {
                        height: 600,
                        type: 'bar'
                    },
                    title: {
                        text: whichPro + '  ' + searchType +'  ' + inMonth + '月  ' + '各项明细大小及预算实际对比',
                        tyle:{
                            color: '#00192E',
                            fontWeight: 'bold',
                            fontSize: '25px'
                        }
                    },
                    subtitle: {
                        text: '注：对预算与实际均为0的项目，自动隐藏'
                    },
                    xAxis: [{
                        categories: categories,
                        reversed: false
                    }, { // mirror axis on right side
                        opposite: true,
                        reversed: false,
                        categories: categories,
                        linkedTo: 0
                    }],

                    yAxis: {
                        title: {
                            text: null
                        },
                        labels: {
                            formatter: function(){
                                return (Math.abs(this.value) / 1000000) + 'M';
                            }
                        },
                        min: -maxdata,
                        max: maxdata
                    },

                    credits:{                   //右边下标HighCharts.com去除  
                        enabled:false  
                    }, 
            
                    plotOptions: {
                        series: {
                            stacking: 'normal'
                        }
                    },

                    exporting: {
                        enabled: false
                    },
                               
                    tooltip: {
                        formatter: function(){
                            return '<b>'+ this.series.name +', '+ this.point.category +'</b><br/>'+
                                '金额: '+ Highcharts.numberFormat(Math.abs(this.point.y), 0);
                        }
                    },
            
                    series: [{
                        name: 'FactFee',
                        data: FactFee
                    }, {
                        name: 'BudgetFee',
                        data: BudgetFee
                    }]
                });
            });
            
        });                          

        }
    
    </script>
</head>

<body>
    
    <form method="get" target='hiddenFrame'>
        选择日期(直接选择所在月任何日期即可查询对应月份数据): <input type="date" id="inDate"/>&nbsp;
        选择查看分公司: <select id="whichPro">
            <option value="上海分公司" selected>上海分公司</option>
            <option value="江苏分公司">江苏分公司</option>
            <option value="浙江分公司">浙江分公司</option>
            <option value="安徽分公司">安徽分公司</option>
            <option value="广东分公司">广东分公司</option>
            <option value="华北分公司">华北分公司</option>
            <option value="山东分公司">山东分公司</option> 
            <option value="福建分公司">福建分公司</option>            
        </select>&nbsp;
        统计方式: <select id="selectType">
            <option value="1" selected>总收入</option>
            <option value="2">总成本</option>
            <option value="3">单价</option>
            <option value="4">总货量</option>
        </select>&nbsp;   
        <input type="submit" onclick="query()" value="查询"/>
    </form>
    <iframe width='0px' height='0px' name='hiddenFrame'></iframe>
    
    <div id='container' style="width: 100%; height: 600px"></div>

</body>
</html>